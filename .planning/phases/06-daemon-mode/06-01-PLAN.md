---
phase: 06-daemon-mode
plan: 01
type: execute
---

<objective>
Add daemon mode to `pleb watch` with file logging and log viewing.

Purpose: Enable pleb to run in the background as a proper daemon, with persistent logging for debugging and monitoring.
Output: `pleb watch --daemon` backgrounds the process with file logging, `pleb log` tails the log.
</objective>

<execution_context>
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@src/cli.rs
@src/config.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add daemon directory helper to Config</name>
  <files>src/config.rs</files>
  <action>
    Add helper method to Config (not PathConfig) that computes the daemon directory:
    `Config::daemon_dir(&self) -> PathBuf` returns `~/.pleb/{owner}-{repo}/`

    Add convenience methods:
    - `Config::log_file(&self) -> PathBuf` returns `daemon_dir()/pleb.log`
    - `Config::pid_file(&self) -> PathBuf` returns `daemon_dir()/pleb.pid`

    Use `dirs::home_dir()` for `~` expansion (add `dirs` crate to Cargo.toml).
    No config field needed - derived from github.owner and github.repo.
  </action>
  <verify>`cargo check` passes</verify>
  <done>Config has daemon_dir(), log_file(), and pid_file() helper methods</done>
</task>

<task type="auto">
  <name>Task 2: Add --daemon flag and Log subcommand to CLI</name>
  <files>src/cli.rs</files>
  <action>
    Add `--daemon` / `-d` flag to `Watch` variant: `#[arg(long, short)]` bool field.
    Add new `Log` variant to `Commands` enum with about text "Tail the pleb log file".
    Add optional `--follow` / `-f` flag to Log (default true) for `tail -f` vs `tail`.
    Add optional `--lines` / `-n` flag to Log (default 50) for number of lines.
  </action>
  <verify>`cargo check` passes, `./target/debug/pleb --help` shows new flag and command</verify>
  <done>CLI accepts `pleb watch --daemon` and `pleb log` commands</done>
</task>

<task type="auto">
  <name>Task 3: Implement daemon mode</name>
  <files>src/main.rs</files>
  <action>
    When `--daemon` flag is set in watch command:
    1. Ensure daemon directory exists using `config.daemon_dir()` (create with `fs::create_dir_all`)
    2. Set up file appender for tracing using `config.log_file()` path
    3. Fork using `daemonize` crate or manual double-fork pattern
    4. Write PID to `config.pid_file()` for later management
    5. Print "Daemon started, PID: X, logging to: Y" before detaching

    Use `daemonize` crate for simplicity - it handles the fork, setsid, chdir, and file descriptor closing.
    Configure tracing to write to log file instead of stdout when daemonized.
  </action>
  <verify>
    Run `./pleb watch --daemon`, verify:
    - Command returns immediately
    - Process is running in background (`ps aux | grep pleb`)
    - PID file exists at `~/.pleb/{owner}-{repo}/pleb.pid`
    - Log file is being written to at `~/.pleb/{owner}-{repo}/pleb.log`
  </verify>
  <done>Daemon mode forks to background, writes PID file, logs to file in namespaced directory</done>
</task>

<task type="auto">
  <name>Task 4: Implement pleb log command</name>
  <files>src/main.rs</files>
  <action>
    Handle `Commands::Log` in main:
    1. Get log file path from `config.log_file()`
    2. Check log file exists, error with helpful message if not (e.g., "No log file found. Is the daemon running? Expected: {path}")
    3. Execute `tail -f <path>` (or `tail -n X` if --follow=false) using std::process::Command
    4. Use `.exec()` on Unix to replace process (or `.status()` for cross-platform)

    Keep it simple - just wrap tail. No need for custom file reading.
  </action>
  <verify>
    Run daemon mode, then `./pleb log` shows live log output.
    `./pleb log -n 20 --no-follow` shows last 20 lines and exits.
  </verify>
  <done>`pleb log` tails the log file, respects --lines and --follow flags</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cargo build --release` succeeds
- [ ] `cargo test` passes
- [ ] `pleb watch --daemon` starts daemon and returns immediately
- [ ] PID file created at `~/.pleb/{owner}-{repo}/pleb.pid`
- [ ] Log file receives output at `~/.pleb/{owner}-{repo}/pleb.log`
- [ ] `pleb log` shows live log output
- [ ] `pleb log -n 10` shows last 10 lines
- [ ] Multiple instances with different configs use separate directories
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No compiler warnings
- Daemon mode works reliably (can start, logs properly, PID file accurate)
- Log command provides easy access to daemon output
</success_criteria>

<output>
After completion, create `.planning/phases/06-daemon-mode/06-01-SUMMARY.md`
</output>
