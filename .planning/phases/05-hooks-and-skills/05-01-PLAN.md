---
phase: 05-hooks-and-skills
plan: 01
type: execute
---

<objective>
Add CLI commands for state transitions and Claude Code hook integration.

Purpose: Enable automatic label state transitions when Claude stops/resumes, providing external visibility into agent activity without tmux polling.
Output: `pleb transition`, `pleb cc-run-hook`, and `pleb hooks` CLI commands, plus auto-installation during provisioning.
</objective>

<execution_context>
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@src/cli.rs
@src/main.rs
@src/github.rs
@src/config.rs
@src/state.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add `pleb transition` CLI command</name>
  <files>src/cli.rs, src/main.rs</files>
  <action>
Add a new `Transition` subcommand to the CLI:
- Arguments: `<issue-number>` (u64) and `<state>` (ready|provisioning|waiting|working|done)
- Handler loads config, creates GitHubClient, calls appropriate label transition
- For transitioning TO a state, remove the current pleb label (if any) and add the target state label
- Use existing `github.rs` methods: `add_label`, `remove_label`, or create a new `set_state` method that finds current pleb label and replaces it
- Handle the case where issue has no current pleb label (just add the new one)
- Print success message: "Issue #123 transitioned to working"
  </action>
  <verify>
`cargo build` succeeds, `pleb transition --help` shows usage, manual test with a real issue transitions labels correctly
  </verify>
  <done>
`pleb transition 123 waiting` updates GitHub labels from current state to `pleb:waiting`
  </done>
</task>

<task type="auto">
  <name>Task 2: Add `pleb cc-run-hook` CLI command</name>
  <files>src/cli.rs, src/main.rs</files>
  <action>
Add a new `CcRunHook` subcommand (displayed as `cc-run-hook` in CLI):
- Argument: `<event>` (stop|user-prompt)
- Reads JSON from stdin (Claude Code hook payload)
- Parse JSON to extract `cwd` field
- Derive issue number from cwd path: extract "issue-XXX" from worktree path like `/path/worktrees/issue-123`
- Map event to target state: "stop" → waiting, "user-prompt" → working
- Call the transition logic (reuse from Task 1)
- If cwd doesn't contain issue pattern, exit silently (not a pleb-managed directory)
- Use serde_json for JSON parsing (already in dependencies via octocrab)

JSON stdin format from Claude Code:
```json
{"session_id": "abc", "cwd": "/path/worktrees/issue-123", "hook_event_name": "Stop", ...}
```
  </action>
  <verify>
`echo '{"cwd":"/tmp/worktrees/issue-42"}' | pleb cc-run-hook stop` transitions issue 42 to waiting (or fails gracefully if issue doesn't exist)
  </verify>
  <done>
`pleb cc-run-hook stop` reads stdin JSON, extracts issue number from cwd, transitions to waiting state
  </done>
</task>

<task type="auto">
  <name>Task 3: Add hooks installation (CLI + auto-provision)</name>
  <files>src/cli.rs, src/main.rs, src/hooks.rs (new)</files>
  <action>
Create new `src/hooks.rs` module with:
- `HooksConfig` struct representing the Claude Code hooks JSON structure
- `generate_hooks_json()` function that returns the hook configuration:
  ```json
  {
    "hooks": {
      "Stop": [{"hooks": [{"type": "command", "command": "pleb cc-run-hook stop"}]}],
      "UserPromptSubmit": [{"hooks": [{"type": "command", "command": "pleb cc-run-hook user-prompt"}]}]
    }
  }
  ```
- `install_hooks(path: &Path)` function that:
  - Creates `.claude/` directory if needed
  - Creates or merges into `.claude/settings.json`
  - If file exists, parse existing JSON, merge hooks section, write back
  - If file doesn't exist, create with just the hooks section

Add CLI subcommands under `Hooks`:
- `pleb hooks generate` - Prints hooks JSON to stdout
- `pleb hooks install` - Installs hooks to current directory's `.claude/settings.json`

Integrate into provisioning (main.rs `process_issue`):
- After `worktree.create_worktree()`, call `hooks::install_hooks(&worktree_path)`
- Log: "Installed Claude Code hooks for issue #{}"
  </action>
  <verify>
`pleb hooks generate` outputs valid JSON, `pleb hooks install` creates/updates `.claude/settings.json`, provisioning a new issue auto-installs hooks in worktree
  </verify>
  <done>
Hooks are automatically installed during provisioning; CLI commands available for manual use/debugging
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes
- [ ] `pleb transition --help` shows usage
- [ ] `pleb cc-run-hook --help` shows usage
- [ ] `pleb hooks generate` outputs valid JSON
- [ ] `pleb hooks install` creates `.claude/settings.json` with correct structure
- [ ] Manual test: `pleb transition <issue> waiting` updates GitHub label
</verification>

<success_criteria>
- All three CLI commands implemented and working
- Hooks auto-installed during issue provisioning
- State transitions update GitHub labels correctly
- No compilation errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/05-hooks-and-skills/05-01-SUMMARY.md`
</output>
