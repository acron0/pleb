---
phase: 10-provision-hooks
type: execute
---

<objective>
Add configurable provisioning hooks that run shell commands after tmux window creation but before Claude starts.

Purpose: Allow users to customize the tmux layout (e.g., split window) and run companion scripts alongside Claude when a new issue is provisioned.
Output: New `[provision]` config section with `on_provision` command list, executed in the new tmux window.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@src/config.rs
@src/main.rs
@src/tmux.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ProvisionConfig to config.rs</name>
  <files>src/config.rs</files>
  <action>
1. Add new `ProvisionConfig` struct:
```rust
#[derive(Debug, Clone, Deserialize, Serialize, Default)]
pub struct ProvisionConfig {
    /// Shell commands to run after window creation, before Claude starts
    /// Commands execute in the tmux window's working directory (the worktree)
    #[serde(default)]
    pub on_provision: Vec<String>,
}
```

2. Add `provision: ProvisionConfig` field to `Config` struct with `#[serde(default)]`

3. No validation needed - empty list is valid default
  </action>
  <verify>cargo build && cargo test config -- --nocapture</verify>
  <done>ProvisionConfig exists, Config has provision field with default, existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add send_keys method to TmuxManager</name>
  <files>src/tmux.rs</files>
  <action>
1. Remove `#[allow(dead_code)]` from existing `send_keys` method (it will now be used)

2. The existing `send_keys` signature is:
```rust
pub async fn send_keys(&self, issue_number: u64, keys: &str) -> Result<()>
```

This is sufficient - it sends keys to the issue's window and presses Enter.
  </action>
  <verify>cargo build</verify>
  <done>send_keys is available without dead_code warning.</done>
</task>

<task type="auto">
  <name>Task 3: Execute on_provision commands in process_issue</name>
  <files>src/main.rs</files>
  <action>
1. After `self.tmux.create_window(issue.number, &worktree_path).await?;` (around line 482)

2. Add loop to execute on_provision commands:
```rust
// Execute on_provision hooks
for cmd in &self.config.provision.on_provision {
    tracing::info!("Running on_provision hook for issue #{}: {}", issue.number, cmd);
    self.tmux.send_keys(issue.number, cmd).await?;
    // Small delay to let command start before next one
    tokio::time::sleep(std::time::Duration::from_millis(100)).await;
}
```

3. This runs BEFORE media download and Claude invocation, giving the hooks time to set up the window layout.
  </action>
  <verify>cargo build</verify>
  <done>process_issue executes on_provision commands after window creation, before Claude.</done>
</task>

<task type="manual">
  <name>Task 4: Add config tests for ProvisionConfig</name>
  <files>src/config.rs</files>
  <action>
1. Add test for default empty on_provision:
```rust
#[test]
fn test_provision_defaults_empty() {
    let config = Config::from_str(MINIMAL_CONFIG).expect("Should parse");
    assert!(config.provision.on_provision.is_empty());
}
```

2. Add test for parsing on_provision commands:
```rust
#[test]
fn test_provision_on_provision_commands() {
    let toml = r#"
[github]
owner = "testowner"
repo = "testrepo"

[labels]
[claude]
[paths]
[prompts]
[watch]
[tmux]

[provision]
on_provision = ["tmux split-window -h", "echo hello"]
"#;
    let config = Config::from_str(toml).expect("Should parse");
    assert_eq!(config.provision.on_provision.len(), 2);
    assert_eq!(config.provision.on_provision[0], "tmux split-window -h");
    assert_eq!(config.provision.on_provision[1], "echo hello");
}
```
  </action>
  <verify>cargo test config -- --nocapture</verify>
  <done>Tests verify default empty and explicit command list parsing.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cargo test` - all tests pass
- [ ] `cargo build --release` - builds without warnings
- [ ] `cargo clippy` - no new warnings
- [ ] Manual test: Add `[provision]\non_provision = ["echo 'provision hook'"]` to pleb.toml and verify it runs on issue pickup
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ProvisionConfig with on_provision field exists and has defaults
- process_issue executes on_provision commands between window creation and Claude invocation
- New config tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-provision-hooks/10-01-SUMMARY.md`
</output>
