---
phase: 08-generic-hooks-ipc
type: execute
---

<objective>
Refactor hook system to use generic Claude Code event names and forward full stdin JSON to daemon via IPC.

Purpose: Enable the daemon to receive rich context from all hook events (not just event type + issue number), allowing smarter state transitions and future extensibility.
Output: Generic `pleb cc-run-hook <EventName>` command, expanded hook generation, HookMessage with full payload.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@src/hooks.rs
@src/ipc.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand HookMessage to carry full payload</name>
  <files>src/ipc.rs</files>
  <action>
1. Replace the `HookEvent` enum with a simple `event_name: String` field (the raw Claude Code event name like "UserPromptSubmit", "PostToolUse", "Stop", "PermissionRequest")
2. Add `payload: serde_json::Value` field to `HookMessage` to carry the full stdin JSON from Claude Code
3. Keep `issue_number: u64` as extracted convenience field
4. Update the test to use the new structure

This allows the daemon to receive ALL context (session_id, transcript_path, cwd, permission_mode, hook_event_name, tool_name, tool_input) and decide how to react.
  </action>
  <verify>cargo test ipc -- --nocapture</verify>
  <done>HookMessage has event_name (String), issue_number (u64), payload (Value). Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor cc-run-hook to accept Claude Code event names directly</name>
  <files>src/main.rs</files>
  <action>
1. Change the `CcRunHook { event }` CLI to document that `event` is the literal Claude Code hook event name (UserPromptSubmit, PostToolUse, Stop, PermissionRequest, etc.)
2. In `handle_cc_run_hook_command`:
   - Remove the "stop" → HookEvent::Stop, "user-prompt" → HookEvent::UserPromptSubmit mapping
   - Pass the event name directly as `event_name: event.to_string()`
   - Pass the full parsed JSON as `payload`
   - Keep the issue_number extraction from cwd
3. Update the logging to use the new event_name

The hook command becomes a simple pass-through: read stdin JSON, extract issue number, forward everything to daemon.
  </action>
  <verify>cargo build && echo '{"cwd":"/path/worktrees/123-test","session_id":"abc"}' | cargo run -- cc-run-hook UserPromptSubmit 2>&1 | grep -q "Could not send hook" && echo "OK - fails gracefully when daemon not running"</verify>
  <done>cc-run-hook accepts any event name, forwards full payload, gracefully fails when daemon offline.</done>
</task>

<task type="auto">
  <name>Task 3: Expand hooks generate to emit full hook suite</name>
  <files>src/hooks.rs</files>
  <action>
1. Update `generate_hooks_json()` to emit hooks for:
   - Stop (existing, update command)
   - UserPromptSubmit (existing, update command)
   - PostToolUse (new)
   - PermissionRequest (new)

2. Change commands from `pleb cc-run-hook stop` to `pleb cc-run-hook Stop` (use actual Claude Code event names)

3. For PostToolUse and PermissionRequest, generate entries like:
```json
"PostToolUse": [{
  "hooks": [{
    "type": "command",
    "command": "pleb cc-run-hook PostToolUse"
  }]
}]
```

4. Update the test to verify all 4 hook types are generated with correct event names.
  </action>
  <verify>cargo test hooks -- --nocapture && cargo run -- hooks generate | jq -e '.hooks | keys | sort == ["PermissionRequest", "PostToolUse", "Stop", "UserPromptSubmit"]'</verify>
  <done>hooks generate outputs Stop, UserPromptSubmit, PostToolUse, PermissionRequest with correct pleb cc-run-hook commands.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cargo test` - all tests pass
- [ ] `cargo build --release` - builds without warnings
- [ ] `cargo run -- hooks generate | jq .` - shows all 4 hook types
- [ ] Manual test: `echo '{"cwd":"/tmp/123-test","session_id":"x"}' | cargo run -- cc-run-hook Stop` - runs without panic
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- HookMessage carries full payload as serde_json::Value
- cc-run-hook accepts literal Claude Code event names
- hooks generate produces Stop, UserPromptSubmit, PostToolUse, PermissionRequest
</success_criteria>

<output>
After completion, create `.planning/phases/08-generic-hooks-ipc/08-01-SUMMARY.md`
</output>
