---
phase: 12-restore-command
plan: 1
type: execute
---

<objective>
Add `pleb restore` command to verify and recreate missing tmux sessions and worktrees for issues in working, waiting, done, or finished states.

Purpose: Sessions can be lost due to daemon restarts, crashes, or manual cleanup. This command ensures all pleb-managed issues have the required infrastructure (tmux window + worktree) without rerunning the full provisioning workflow.

Output: CLI command that audits all managed issues and recreates missing sessions/worktrees as needed.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@src/cli.rs
@src/main.rs
@src/github.rs
@src/tmux.rs
@src/worktree.rs
@src/hooks.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Restore command to CLI</name>
  <files>src/cli.rs</files>
  <action>
    Add a new Restore variant to the Commands enum with no parameters. The command should be documented as "Verify and recreate missing tmux sessions and worktrees for managed issues". Place it after the Cleanup command variant to keep related commands together.
  </action>
  <verify>cargo build succeeds with no warnings on the cli module</verify>
  <done>Restore command exists in CLI enum and compiles</done>
</task>

<task type="auto">
  <name>Task 2: Implement restore command handler</name>
  <files>src/main.rs</files>
  <action>
    1. Add Commands::Restore match arm in handle_command function that calls handle_restore_command(config).await

    2. Implement async fn handle_restore_command(config: Config) -> Result<()> that:
       - Creates GitHubClient, TmuxManager, WorktreeManager instances from config
       - Fetches all open issues with working, waiting, done, AND finished labels using github.get_issues_with_label() for each label
       - Deduplicates issues (an issue may have multiple labels)
       - For each issue:
         a. Extract issue_number, check tmux.window_exists(issue_number) and worktree.get_worktree_path(issue_number)
         b. If BOTH exist: log "Issue #{} already has session" and continue
         c. If either is missing:
            - Log "Restoring session for issue #{}: {}"
            - Construct branch_name using same format as process_issue: "{issue_number}-{slug}_{username}_{suffix}" (use slugify and gh_username from main.rs)
            - Call worktree.create_worktree(issue_number, &branch_name, &branch_name) (idempotent)
            - Call tmux.create_window(&branch_name, &worktree_path) (idempotent)
            - Install hooks: hooks::install_hooks(&worktree_path)
            - Copy pleb.toml to worktree if exists (same logic as process_issue)
            - Print "Restored session for issue #{}"
       - After processing all issues, print summary: "Checked X issues, restored Y sessions"

    3. DO NOT invoke Claude, do NOT process media, do NOT run provision hooks, do NOT change labels. This is infrastructure-only restoration.

    4. Get gh_username by calling GitHubClient::get_current_user() (already exists in github.rs, used by Orchestrator::new in main.rs around line 400)
  </action>
  <verify>
    - cargo build succeeds
    - cargo test passes
    - Command structure matches existing handle_cleanup_command pattern
  </verify>
  <done>
    - handle_restore_command function exists and compiles
    - Function fetches issues with all managed labels (working, waiting, done, finished)
    - Function checks for missing tmux windows and worktrees
    - Function recreates missing infrastructure using existing create_worktree/create_window functions
    - Function does NOT invoke Claude, process media, or change labels
    - Function logs restored issues and prints summary
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cargo build` succeeds without errors or warnings
- [ ] `cargo test` passes all tests
- [ ] `pleb restore --help` shows the restore command
- [ ] Code follows existing patterns (similar to cleanup command structure)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No compilation errors or warnings
- Restore command is available in CLI
- Restore logic correctly identifies and recreates missing sessions
- Phase 12 complete, ready for next phase
</success_criteria>

<output>
After completion, create `.planning/phases/12-restore-command/12-01-SUMMARY.md`:

# Phase 12 Plan 1: Restore Command Summary

**Added `pleb restore` command to verify and recreate missing sessions**

## Accomplishments
- Added Restore command variant to CLI
- Implemented restore logic that checks all managed issues
- Recreates missing worktrees and tmux windows without full provisioning

## Files Created/Modified
- `src/cli.rs` - Added Restore command
- `src/main.rs` - Added handle_restore_command implementation

## Decisions Made
None

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase complete, ready for next phase
</output>
