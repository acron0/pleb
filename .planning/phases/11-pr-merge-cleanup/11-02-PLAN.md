---
phase: 11-pr-merge-cleanup
plan: 02
type: execute
---

<objective>
Implement PR merge detection in the daemon watch loop.

Purpose: Automatically detect when a PR associated with an issue has been merged and transition to "finished" state.
Output: Daemon polls active issues, detects merged PRs, transitions to finished, updates tmux window title.
</objective>

<execution_context>
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/11-pr-merge-cleanup/11-01-SUMMARY.md
@src/github.rs
@src/main.rs
@src/config.rs
@src/state.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PR merge check to GitHub client</name>
  <files>src/github.rs</files>
  <action>
    1. Add `check_pr_merged(&self, issue_number: u64) -> Result<Option<bool>>` method
       - Returns Ok(None) if no PR found for this issue
       - Returns Ok(Some(true)) if PR exists and is merged
       - Returns Ok(Some(false)) if PR exists but not merged
    2. Use `gh pr list` with branch prefix (existing pattern from `get_pull_request_for_issue`)
       but also fetch `state` field to check if merged
    3. Alternative: use `gh pr view <branch> --json state,mergedAt` for more direct lookup
    4. Handle errors gracefully (gh not installed, network issues) - log warning, return Ok(None)
  </action>
  <verify>cargo build && cargo test --lib github::</verify>
  <done>check_pr_merged() exists, returns correct merge status, handles missing PRs gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Detect merged PRs in watch loop</name>
  <files>src/main.rs</files>
  <action>
    1. Add new method `check_merged_prs(&self) -> Result<()>` to Orchestrator
    2. Fetch issues with working, waiting, AND done labels (all active states)
    3. For each issue, call `github.check_pr_merged(issue.number)`
    4. If merged: transition to Finished state, update tmux window title to "finished"
    5. Call `check_merged_prs()` in the poll loop (can be same frequency or less frequent)
    6. Log transitions: "Issue #X PR merged, transitioning to finished"
    7. Consider: skip check if issue was just provisioned (no PR yet) - optimization
  </action>
  <verify>cargo build && cargo clippy</verify>
  <done>Daemon detects merged PRs on active issues, transitions to finished, updates tmux title</done>
</task>

<task type="auto">
  <name>Task 3: Update pleb status for finished state</name>
  <files>src/main.rs</files>
  <action>
    1. In `handle_status_command()` single-issue branch: handle Finished state display
    2. In `handle_status_command()` daemon-status branch: include finished label in labels list to fetch
    3. Add "[finished]" to state_str mapping
    4. Ensure finished issues appear in "Managed Issues" list
  </action>
  <verify>cargo build</verify>
  <done>pleb status shows finished state correctly for both single-issue and daemon-status views</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all tests
- [ ] `cargo clippy` has no warnings
- [ ] Manual test: Create a test PR, merge it, verify daemon transitions issue to finished
</verification>

<success_criteria>
- Daemon polls all active issues (working/waiting/done) for merged PRs
- When PR is merged, issue transitions to "finished" automatically
- Tmux window title updates to "finished"
- `pleb status` displays finished state correctly
- No errors when PR doesn't exist or gh CLI unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/11-pr-merge-cleanup/11-02-SUMMARY.md`
</output>
