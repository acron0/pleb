---
phase: 11-pr-merge-cleanup
plan: 03
type: execute
---

<objective>
Implement cleanup functionality via IPC and slash command.

Purpose: Allow users to clean up worktrees and tmux sessions for finished issues, with explicit confirmation.
Output: `/pleb-cleanup` slash command that requests confirmation, then triggers daemon to delete worktree and kill tmux window.
</objective>

<execution_context>
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/11-pr-merge-cleanup/11-01-SUMMARY.md
@.planning/phases/11-pr-merge-cleanup/11-02-SUMMARY.md
@src/ipc.rs
@src/main.rs
@src/commands.rs
@src/cli.rs
@src/worktree.rs
@src/tmux.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cleanup CLI command and daemon handler</name>
  <files>src/cli.rs, src/main.rs, src/worktree.rs, src/tmux.rs</files>
  <action>
    1. Add `Cleanup { issue_number: u64 }` variant to Commands enum in cli.rs
    2. Add `cleanup_issue(&self, issue_number: u64) -> Result<()>` to Orchestrator:
       - Get worktree path for issue from config (worktree_base/issue-{number})
       - Call worktree.remove_worktree() to delete the worktree
       - Call tmux.kill_window(issue_number) to kill the tmux window
       - Log cleanup actions
    3. Add `remove_worktree(&self, issue_number: u64) -> Result<()>` to WorktreeManager if not exists
    4. Add `kill_window(&self, issue_number: u64) -> Result<()>` to TmuxManager if not exists
    5. Handle cleanup command in main.rs:
       - Connect to daemon via IPC OR run cleanup directly (simpler: direct execution)
       - For simplicity: cleanup can run directly without daemon (just needs config for paths)
    6. Print confirmation of what was cleaned up
  </action>
  <verify>cargo build && cargo test</verify>
  <done>pleb cleanup <issue> command exists, deletes worktree and kills tmux window</done>
</task>

<task type="auto">
  <name>Task 2: Create /pleb-cleanup slash command</name>
  <files>src/commands.rs</files>
  <action>
    1. Add PLEB_CLEANUP_COMMAND constant with markdown instructions:
       - Extract issue number from current directory path
       - ALWAYS ask for confirmation first: "This will terminate this tmux window and delete the worktree. Are you sure? (yes/no)"
       - Only proceed if user confirms with "yes"
       - Warn user: "This window is about to be terminated. Goodbye!"
       - Run: `pleb cleanup <issue-number>`
       - Note: Claude should use /exit or stop after running cleanup since the session will be killed
    2. Add "pleb-cleanup" to generate_command_file() match
    3. Add "pleb-cleanup" to install_commands() commands list
    4. Update tests to include pleb-cleanup
  </action>
  <verify>cargo test --lib commands::</verify>
  <done>/pleb-cleanup slash command exists, requires confirmation, warns about session termination</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build` succeeds without errors
- [ ] `cargo test` passes all tests
- [ ] `cargo clippy` has no warnings
- [ ] Manual test: Run /pleb-cleanup in a test session, confirm it asks for confirmation
- [ ] Manual test: Confirm cleanup actually removes worktree and kills window
</verification>

<success_criteria>
- `pleb cleanup <issue>` CLI command works standalone
- `/pleb-cleanup` slash command always asks for confirmation before proceeding
- Cleanup removes the git worktree
- Cleanup kills the tmux window
- User is warned that their session is about to terminate
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-pr-merge-cleanup/11-03-SUMMARY.md`
</output>
